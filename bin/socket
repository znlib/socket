#!/usr/bin/env php
<?php

use Illuminate\Container\Container;
use Psr\Container\ContainerInterface;
use ZnBundle\User\Domain\Interfaces\Services\AuthServiceInterface;
use ZnBundle\User\Domain\Services\AuthService3;
use ZnCore\Base\Libs\App\Interfaces\ContainerConfiguratorInterface;
use ZnLib\Socket\Domain\Apps\WebSocketApp;
use ZnLib\Socket\Domain\Libs\SocketDaemon;
use ZnSandbox\Sandbox\App\Libs\ZnCore;

define('MICRO_TIME', microtime(true));

require __DIR__ . '/../../../autoload.php';

$container = Container::getInstance();
$znCore = new ZnCore($container);
$znCore->init();

$appFactory = $container->get(WebSocketApp::class);
$appFactory->init();

$znCore->addContainerConfig(function (ContainerConfiguratorInterface $containerConfigurator) {
    $containerConfigurator->singleton(AuthServiceInterface::class, function (ContainerInterface $container) {
        /** @var AuthService3 $authService */
        $authService = $container->get(AuthService3::class);
        return $authService;
    });
});

/** @var SocketDaemon $daemon */
$daemon = $container->get(SocketDaemon::class);
$daemon->runAll();
